var e={d:(t,i)=>{for(var n in i)e.o(i,n)&&!e.o(t,n)&&Object.defineProperty(t,n,{enumerable:!0,get:i[n]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t),r:e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})}},t={};e.d(t,{TK:()=>xe,ux:()=>i,sP:()=>Me,cU:()=>Oe,Ce:()=>w,iK:()=>de,Ks:()=>y,VN:()=>u,fw:()=>Se,Hv:()=>f,vD:()=>ne,Gh:()=>G,kK:()=>J,u7:()=>S,tP:()=>O,Fi:()=>g,wn:()=>re,$W:()=>oe,eJ:()=>b,H6:()=>d,Fn:()=>k,L4:()=>_e,fM:()=>se,Lg:()=>ie,v5:()=>ye,U:()=>ge,CA:()=>we,jl:()=>P});var i={};e.r(i),e.d(i,{BUTTON_H2:()=>U,BUTTON_H2H:()=>W,DOTS_MENU:()=>H,ENTITY_COLLAPSE:()=>Q,ENTITY_EXPAND:()=>K});class n{render(e,t,i){let n=document.createElement("input");return n.type="input",n.value=null==t?"":t,n.style.width="150px",n.oninput=h(e.key,i&&i.onchange),n}parse(e){let t=("INPUT"==e.tagName?e.value:e.innerText).trim();return t?parseFloat(t):void 0}present(e,t){return $("<span/>").text(null==t?"":t)}}class s{render(e,t,i){let n=document.createElement("select");for(let t of e.options){let e=document.createElement("option");e.text=t.key,e.value=s.getOptionValue(t),n.add(e)}return n.style.width="150px",n.value=t,n.onchange=h(e.key,i&&i.onchange),n}static getOptionValue(e){return e.hasOwnProperty("value")?e.value:e.key}parse(e,t){if("SELECT"==e.tagName){if(e.selectedIndex<0)return;for(let i of t.options){let t=s.getOptionValue(i);if(t==e.value)return t}return null}return e.value}present(e,t){let i=e.options.find((e=>s.getOptionValue(e)==t));return $("<span/>").text(i?i.key:"").prop("value",t)}}let r=[{key:"string"},{key:"text"},{key:"integer"},{key:"number"},{key:"float"},{key:"enum"},{key:"type"},{key:"boolean"},{key:"image"},{key:"object"},{key:"...#"}];class a{render(e,t){let i=document.createElement("textarea");return i.appendChild(document.createTextNode(JSON.stringify(t,null,2))),i.style.fontFamily="Courier New,serif",i.rows=6,i.style.width="300px",i}parse(e){return JSON.parse(e.value)}present(e,t){return $("<span/>").text(JSON.stringify(t,null,2))}}class l{constructor(e){this.jelemCls=e}render(e,t,i){return createJelem(this.jelemCls,e,t,i)}parse(e,t){return getJelem(e,this.jelemCls).wrap().parse(t)}present(e,t,i){return createJelem(this.jelemCls,e,t,i)}getLabel(e,t){if(this.jelemCls.getLabel)return this.jelemCls.getLabel(e,t);{if(!t)return"";let i=e.fields.find((e=>e.asLabel)),n=t[i?i.key:e.fields[0].key];return void 0!==n?n:""}}}let o={};function d(e,t){t instanceof Function&&(t=new l(t)),o[e]=t}function p(e){return o[e]}function h(e,t){if(t)return function(i){t(e,i.target)}}function c(e){if(e instanceof Object&&!(e instanceof R||e instanceof L))if(e instanceof Array){for(let t of e)if(!c(t))return!1}else{if(!e._id)return!1;for(let t in e)if(!c(e[t]))return!1}return!0}function g(e){if(e instanceof Object&&!(e instanceof R||e instanceof L))if(e instanceof Array)for(let t of e)g(t);else{for(let t in e)g(e[t]);e._id||(e._id=crypto.randomUUID())}return e}async function u(e){let t=A(e);if(t)return await t.storage.getAllEntities(t.args)}async function f(e,t){let i=A(e);if(i)return await i.storage.getEntity(i.args,t)}async function y(e,t){let i=A(e);if(i)return await i.storage.deleteEntity(i.args,t)}async function w(e,t){let i=A(e);if(i)return await i.storage.addEntity(i.args,g(t))}d("string",new class{render(e,t,i){let n=document.createElement("input");return n.type="input",n.value=null==t?"":t,n.style.width="100%",e.placeholder&&(n.placeholder=e.placeholder),n.oninput=h(e.key,i&&i.onchange),n}parse(e){return"INPUT"==e.tagName?e.value:e.innerText}present(e,t){return $("<span/>").text(null==t?"":t)}}),d("text",new class{render(e,t,i){let n=$("<div/>",{style:"border:1px solid gray; border-radius:3px; white-space:pre-wrap; padding:2px; flex:1 1"}).attr("contentEditable","plaintext-only").attr("tabIndex",-1).text(t);return n.get(0).oninput=h(e.key,i&&i.onchange),n}parse(e){return e.innerText}present(e,t){return $("<div/>").css("white-space","pre-wrap").text(null==t?"":t)}}),d("integer",new class{render(e,t,i){let n=document.createElement("input");return n.type="input",n.value=null==t?"":t,n.style.width="150px",n.oninput=h(e.key,i&&i.onchange),n}parse(e){let t=("INPUT"==e.tagName?e.value:e.innerText).trim();return t?parseInt(t):void 0}present(e,t){return $("<span/>").text(null==t?"":t)}}),d("number",new n),d("float",new n),d("enum",new s),d("type",new class{render(e,t,i){let n=document.createElement("select");for(let e of r){let t=document.createElement("option");t.text=e.key,t.value=e.value||e.key,n.add(t)}return n.style.width="150px",n.value=t,n.onchange=h(e.key,i&&i.onchange),n}parse(e,t){if("SELECT"==e.tagName){if(e.selectedIndex<0)return;for(let t of r)if((t.value||t.key)==e.value)return t.value||t.key;return null}return e.value}present(e,t){let i=r.find((e=>(e.value||e.key)==t));return $("<span/>").text(i?i.key:"").prop("value",t)}}),d("boolean",new class{render(e,t,i){let n=document.createElement("input");return n.type="checkbox",n.checked=t,n.onchange=h(e.key,i&&i.onchange),n}parse(e){return e.checked}present(e,t){let i=document.createElement("input");return i.type="checkbox",i.checked=t,i.disabled=!0,i}}),d("map",new a),d("list",new a),d("code",new class{render(e,t){let i=document.createElement("div");return i.style.whiteSpace="pre",i.style.fontFamily="Courier New,serif",i.style.border="1px solid gray",i.style.padding="5px",i.contentEditable=!0,i.innerText=t,i}parse(e){return e.innerText}present(e,t){return $("<span/>").text(t).css("white-space","pre")}});let m=[];function b(e,t){m.push({match:new x(e),storage:t})}function A(e){for(let t of m){let i=t.match.parse(e);if(i)return{args:i,storage:t.storage}}}class x{constructor(e){this.pattern=e,this.parts=[];let t,i=/\/:[a-zA-Z0-9_]+/g,n=0;for(;null!=(t=i.exec(e));){let s=t.index,r=i.lastIndex;this.addTextPattern(n,s+1),this.parts.push({type:"arg",key:e.substring(s+2,r)}),n=r}this.addTextPattern(n,e.length)}addTextPattern(e,t){t>e&&this.parts.push({type:"text",text:this.pattern.substring(e,t)})}parse(e){let t={},i=0;for(let n of this.parts)if("text"==n.type){if(!e.startsWith(n.text,i))return;i+=n.text.length}else if("arg"==n.type){let s=e.indexOf("/",i);s=s>0?s:e.length;let r=e.substring(i,s);if(!r)return;t[n.key]=r,i=s}let n=e.substr(i);if(!n||"/"==n)return t[0]=e,t}}class v{constructor(){this.listeners=[],this.namedListeners={}}destruct(){for(;this.listeners.length>0;)this.listeners.pop();for(let e in this.namedListeners)delete this.namedListeners[e]}add(e,t){e instanceof Function?this.listeners.push(e):this.namedListeners[e]=t}remove(e){if(e instanceof Function){let t=this.listeners.findIndex((t=>t==e));if(t<0)return;t>0&&(this.listeners[t]=this.listeners[0]),this.listeners.shift()}else delete this.namedListeners[e]}publish(e){for(let t of this.listeners)try{t(e)}catch(e){console.error(e)}for(let t in this.namedListeners)try{this.namedListeners[t](e)}catch(e){console.error(e)}}}let E={};function k(e,t){E[e]=t}function D(e){return e.startsWith("#")&&(e=E[e].type),"object"==e}k("#meta",{type:"object",fields:[{key:"key",type:"string"},{key:"description",type:"string"},{key:"type",type:"type"},{key:"array",type:"boolean"},{key:"fields",type:"#meta",array:!0,cond:{type:"object"}},{key:"options",type:"object",array:!0,cond:{type:"enum"},fields:[{key:"key",type:"string"},{key:"value",type:"string"}]}]});const M={mbase:function(e,t,i){i?.storage&&(i={...i,patchable:!0}),this.__MD={meta:e,options:i||{},listeners:new v},i?.storage&&(this.__MD.originDataNormalized=c(t),this.__MD.originData=g(t)),Object.defineProperty(this,"__MD",{writable:!0,enumerable:!1})},getMeta:function(){return this.__MD.meta},getParent:function(){return this.__MD.options&&this.__MD.options.parent},getRoot:function(){for(let e=this;null!=e;){let t=e.getParent();if(!t)return e;e=t}},getJPath:function(){let e=[];for(let t=this;null!=t;t=t.getParent()){let i=t.getParent();if(!i)break;i instanceof L?e.unshift("#"+t.getId()):e.unshift(t.__MD.meta.key)}return e.join(".")},getListener:function(){return this.__MD.listeners},getStore:function(){for(let e=this;null!=e;e=e.getParent())if(e instanceof R&&e.__MD.options.storage)return e},getOld:function(){let e,t=[];for(e=this;null!=e&&!e.__MD.options.storage;e=e.getParent()){let i=e.getParent();i&&i instanceof L?t.unshift("#"+e.getId()):t.unshift(e.__MD.meta.key)}let i=e.__MD.originData;for(let e of t){if(!i)break;if(e.startsWith("#")){let t=e.substring(1);i=i.find((e=>e._id==t))}else i=i[e]}return{jpath:t.join("."),old:i}},getOriginalData:function(){let e,t=[];for(e=this;null!=e&&!e.__MD.options.storage;e=e.getParent()){let i=e.getParent();i&&i instanceof L?t.unshift("#"+e.getId()):t.unshift(e.__MD.meta.key)}let i=e.__MD.originData;for(let e of t){if(!i)return;if(e.startsWith("#")){let t=e.substring(1);i=i.find((e=>e._id==t))}else i=i[e]}return i},setStorageStatus:function(e){if(e){let t;for(let i=this;null!=i;i=i.getParent())if(i instanceof R){if(i.__MD.status==e)return this;t||(t=i)}P(t,(e=>{e.__MD.status&&(e.__MD.status=0,e.publish({type:"storageChange",status:0}))})),t.__MD.status=e,t.publish({type:"storageChange",status:e})}else this.__MD.status&&(this.__MD.status=e,this.publish({type:"storageChange",status:e}));return this},getStorageStatus:function(){return this.__MD.status},publish:function(e){let t=this.getJPath();this.__MD.listeners.publish(e);let i=t.length-1;for(let n=this.getParent();null!=n;n=n.getParent()){let s=t.lastIndexOf(".",i);i=s-1;let r={type:"childEvent",jpath:s>=0?t.substring(s+1):t,event:e};n.__MD.listeners.publish(r)}return this},debug:function(){console.log("\\\\ entity \\\\");for(let e in this)console.log(`${e} = ${this[e]}`);console.log("////")},cancel:async function(){let e=[];P(this,(async t=>{1==t.getStorageStatus()&&e.push(t)}));for(let t of e)await t._cancel()},save:async function(){let e=[];P(this,(t=>{1==t.getStorageStatus()&&e.push({...t.getOld(),new:t})})),await this.patch(e);for(let t of e)t.new.setStorageStatus(0)},patch:async function(e){let t=this.getRoot(),i=t.__MD.options?.storage,n=t.__MD.options?.eid;t.__MD.originDataNormalized||(n?await async function(e,t,i){let n=A(e);if(n)return await n.storage.updateEntity(n.args,t,g(i))}(i,n,t.__MD.originData):await async function(e,t){let i=A(e);if(i)return await i.storage.setAllEntities(i.args,t)}(i,t.__MD.originData),t.__MD.originDataNormalized=!0),n&&e.forEach((e=>e.jpath="#"+n+(e.jpath?"."+e.jpath:"")));let s=await async function(e,t){let i=A(e);if(i)return await i.storage.patchAllEntities(i.args,t)}(i,e);for(let e of s){let i=e.jpath;if(n){let e=i.indexOf(".");i=e>=0?i.substring(e+1):""}N(t.__MD.originData,i,e.old,e.new),await N(t,i,e.old,e.new)}}};async function S(e,t,i){let n=i?await f(e,i):await u(e);if(!t&&(t=await async function(e){let t=A(e);if(t&&t.storage.getMeta)return await t.storage.getMeta(t.args)}(e),!t))throw new Error("Invalid Meta");return await C(t),!t.array&&n instanceof Array&&(n=n[0]),O(t,n,{storage:e,eid:i})}async function C(e){if(e.type.startsWith("#")&&await async function(e){E[e]}(e.type),e.fields)for(let t of e.fields)await C(t)}function O(e,t,i){return(e=function(e){if((e=Object.assign({},e)).type.startsWith("#")){let i=(t=e.type,E[t]);e.fields=i.fields,e.typeId=e.type,e.type="object",i.render&&(e.render=Object.assign({},i.render,e.render))}var t;if("object"===e.type){let t=e.render?.ignorable;J(t)||(e.fields=e.fields.map((e=>J(e.render?.ignorable)?{...e,render:{...e.render,ignorable:t}}:e)))}else delete e.fields;return"enum"!==e.type&&delete e.options,e}(e)).array?(void 0===t&&(t=[]),t instanceof L?t:new L(e,t,i)):e.fields&&e.fields.length>0?(void 0===t&&(t={}),t instanceof R?t:new R(e,t,i)):t}function j(e){e&&(e instanceof R||e instanceof L)&&e.destruct()}async function I(e){if(e)return(e instanceof R||e instanceof L)&&await e._delete(),j(e),e}function J(e){return null==e}function P(e,t){if(e instanceof L)for(let i of e)P(i,t);else if(e instanceof R){t(e);for(let i in e)P(e[i],t)}}async function N(e,t,i,n){let s=t.split("."),r=e;for(let e=0;e<s.length-1;e++){let t=s[e];if(t.startsWith("#")){let e=t.substring(1),i=r.find((t=>t._id==e));i||(r.push({_id:e}),i=r[r.length-1]),r=i}else{let i=r[t];if(!i){let n=s[e+1];r[t]=n.startsWith("#")?[]:{},i=r[t]}r=i}}let a=s.pop();if(a.startsWith("#")){let e=a.substring(1),t=r.findIndex((t=>t._id==e));r instanceof L?n?t>=0?await r[t].update(n):r.push(n):t>=0&&r.pop(t):n?t>=0?r[t]=n:r.push(n):t>=0&&r.splice(t,1)}else if(a)r[a]=n;else if(r instanceof R||r instanceof L)await r.update(n);else if(r instanceof Array){for(;r.length>0;)r.pop();n.forEach((e=>r.push(e)))}else{for(let e in r)delete r[e];for(let e in n)r[e]=n[e]}}function B(e){if(e instanceof Object){if(e instanceof Array){let t=[];for(let i of e)t.push(B(i));return t}{let t={};for(let i in e)"_id"!=i&&"__pos"!=i&&(t[i]=B(e[i]));return t}}return e}class R{constructor(e,t,i){this.mbase(e,t,i),Object.assign(this.__MD,{_id:t&&t._id||crypto.randomUUID(),__pos:t&&t.__pos,status:0,data:{}});for(let i of e.fields)if(Object.defineProperty(this,i.key,this.getPropertyDescriptor(i.key)),t&&(t.hasOwnProperty(i.key)||D(i.type)||i.array)){let e=this.__MD.options?.patchable;this.__MD.data[i.key]=O(i,t[i.key],Object.assign({parent:this},e&&{patchable:e}))}Object.defineProperty(this,"_id",{get:()=>this.__MD._id,enumerable:!0}),Object.defineProperty(this,"__pos",{get:()=>this.__MD.__pos,set:e=>this.__MD.__pos=e,enumerable:!0})}destruct(){this.__MD.listeners.destruct();for(let e in this.__MD.data)j(this.__MD.data[e]);delete this.__MD.options.parent}async _cancel(){let e=this.getOriginalData();e?._id?(await this.update(e),this.setStorageStatus(0)):this.getParent().remove(this)}async _delete(){for(let e=this.getParent();null!=e;e=e.getParent())if(e instanceof R&&e.__MD.status)return;await this.patch([{jpath:this.getJPath(),old:this.getOriginalData(),new:null}])}_remove(e){for(let t in this.__MD.data)if(this.__MD.data[t]==e)return delete this.__MD.data[t],e}getPropertyDescriptor(e){return{set:t=>this.setProperty(e,t),get:()=>this.getProperty(e),enumerable:!0}}async setProperty(e,t){let i=this.__MD.data[e];i instanceof R||i instanceof L?await i.update(t):i!==t&&(this.__MD.data[e]=t,this.setStorageStatus(1),this.publish({type:"fieldChange",key:e,value:t}))}getProperty(e){return this.__MD.data[e]}async update(e){for(let t of this.__MD.meta.fields)await this.setProperty(t.key,e&&e[t.key]);if(e&&void 0!==e.__pos&&e.__pos!=this.__pos){this.__pos=e.__pos;let t=this.getParent();t&&t instanceof L&&t.reorder()}return this}remove(e){}getId(){return this.__MD._id}getEditable(){return this.__MD.options.storage||this.__MD.options.patchable}async delete(){let e=this.getParent();e?await e.remove(this):await I(this)}}Object.assign(R.prototype,M);class L extends Array{constructor(e,t,i){if(super(),this.mbase(e,t,i),Object.assign(this.__MD,{entityMeta:{...e,array:!1}}),t&&t.length)for(let e of t)super.push(this._makeEntity(e));this.order()}getEntityMeta(){return this.__MD.entityMeta}destruct(){this.__MD.listeners.destruct();for(let e=0;e<this.length;e++)j(this[e]);delete this.__MD.options.parent}_delete(){}order(){if(this.__MD.entityMeta.fields&&this.__MD.entityMeta.fields.length>0){this.sort(((e,t)=>void 0!==e.__pos?void 0!==t.__pos?e.__pos-t.__pos:-1:void 0!==t.__pos?1:0));let e=0;for(let t of this)void 0!==t.__pos?e=t.__pos:(e+=1024,t.__pos=e)}}reorder(){if(this.__MD.entityMeta.fields&&this.__MD.entityMeta.fields.length>0){let e=!1,t=0;for(let i of this){let n=i.__pos||1/0;if(n<t){e=!0;break}t=n}e&&(this.order(),this.publish({type:"change"}))}}_insertEntity(e,t){return void 0===t&&void 0!==e.__pos||(t=void 0!==t?t:this.length-1,e instanceof R&&(t<=0?e.__pos=this.length>0?this[0].__pos/2:1024:t>=this.length?e.__pos=this.length>0?this[this.length-1].__pos+1024:1024:e.__pos=(this[t-1].__pos+this[t].__pos)/2)),super.splice(t,0,e),e instanceof R?e.setStorageStatus(1):this.setStorageStatus(1),e}_popEntity(e){let t=this[e];return super.splice(e,1),t instanceof R?t.setStorageStatus(1):this.setStorageStatus(1),t}_makeEntity(e){let t=this.__MD.options?.patchable;return O(this.__MD.entityMeta,e,Object.assign({parent:this},t&&{patchable:t}))}_normalizeRoundIndex(e,t){return void 0===e&&(e=-1),e<0&&(e+=t),e<0?0:e>=t?t-1:e}push(e,t){let i=this._insertEntity(this._makeEntity(e),this._normalizeRoundIndex(t,this.length+1));return this.publish({type:"change"}),i}move(e,t){e<0||e>this.length-1||t<0||t>this.length-1||e==t||(this._insertEntity(this._popEntity(e),t),this.publish({type:"change"}))}async pop(e){let t=await I(this._popEntity(this._normalizeRoundIndex(e,this.length)));return this.publish({type:"change"}),t}_updateAsValue(e){let t,i=!1;for(t=0;t<e.length;t++){let n=e[t];this[t]!==n&&(i=!0,super.splice(t,0,n))}for(;this.length>t;)super.pop(),i=!0;return i}async _updateAsEntity(e){let t=!1,i=[];for(let n=0;n<e.length;n++){let s=e[n],r=this.find((e=>e.getId()==s._id));r?(s.__pos&&s.__pos!=r.__pos&&(t=!0),await r.update(s)):i.push(n)}if(this.length+i.length>e.length)for(let i=this.length-1;i>=0;i--){let n=this[i];e.find((e=>e._id==n._id))||(this.splice(i,1),await I(n),t=!0)}if(i.length>0){for(let t of i){let i=this._makeEntity(e[t]);this._insertEntity(i,i.__pos?void 0:t)}this.order(),t=!0}return t}async update(e){void 0===e&&(e=[]),(this.__MD.entityMeta.fields&&this.__MD.entityMeta.fields.length>0?await this._updateAsEntity(e):this._updateAsValue(e))&&this.publish({type:"change"})}async remove(e){for(let t=0;t<this.length;t++)if(this[t]===e)return await I(this._popEntity(t)),this.publish({type:"change"}),e}}Object.assign(L.prototype,M);class F{constructor(e,t){this.items=e.map(((e,i)=>({model:e,jelem:$(t[i])})))}popByValue(e){let t=this.items.findIndex((t=>t.model===e));if(t>=0){let e=this.items[t];return this.items.splice(t,1),e}}getHead(){return this.items[0]}remove(){for(let e of this.items)e.jelem.remove()}}function T(e,t,i,n){let s=e.children().toArray().map((e=>$(e))),r=new F(s.map((e=>i(e))),s);for(let i of t){let t=r.getHead(),s=r.popByValue(i);if(s)s!==t&&s.jelem.insertBefore(t.jelem);else{let s=n(i);t?s.insertBefore(t.jelem):s.appendTo(e)}}r.remove()}const U=createClass("font-size: 14px;\nfont-weight: bold;\nborder: none;\nborder-radius: 3px;\npadding: 4px 10px 4px 10px;\nmargin-right: 5px;\ncursor: hand;"),W=createClass("background-color: #0052CC;\ncolor: white;\nfont-size: 14px;\nfont-weight: bold;\nborder: none;\nborder-radius: 3px;\npadding: 4px 10px 4px 10px;\nmargin-right: 5px;\ncursor: hand;"),H=createClass("\nbackground-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAAXNSR0IArs4c6QAAALNJREFUOE/FkiEOQjEMhtvdAcUh2t4AzgEWg0XADQgCi0JyD57ErT0AEvUuQDAlSx4Jgi0ZS6Cmou3f9duPUAgiGocQHjHGPteGuQIRzRHxAAB3RNzFGPeferMCzHwGgMkw1KnqtEqg+QVpWxODEtz3WolBun+GiFd3v6hqV8VARDbuvh2Gjqq6+K0AM7ed0AwxCYjIKOWvrCwiK3dfJ4G/WxncfWlmp6pvfFk5ZTO75aA+AaXmWhEjDJDPAAAAAElFTkSuQmCC);\ncursor: hand;\nwidth: 16px;\nheight: 16px;"),Q=createClass("\nmargin-right:auto;\nbackground:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAAXNSR0IArs4c6QAAALdJREFUOE/Nk+ENgjAQhe8YR91BnKBtYpzCHcQdnMKYXDuBuIM4Do+UCEEsQtM/9m+vX++9e8eUeDjxPbUArXXBzFsiyhcASwAPa23ha1uAMeYJ4GitLecAWuucmS8ishkCICJfcpRSK+fcaww1xvT1XQdBgO+s+2kIiQFMgRd3EAfwmrMsuxLROmBmVdf1wXvyxxIC40qbQkwO7gDOEUk8iciuT+J7F/YT7o+VVQBuH7swl/9f9w29apsRck7yYAAAAABJRU5ErkJggg==) no-repeat 2px;\npadding-left: 20px;\ncursor: hand;\npadding-right: 10px;"),K=createClass("\nmargin-right:auto;\nbackground:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAAXNSR0IArs4c6QAAAJlJREFUOE/dk9EJwmAMhC8gLqM7WDdIwDHcwbqDYwiXDaw76DIinFi0KFT6S9+a11w+kuNiGFk2ch4twN1rM1sBqAqAjaRzZtZPbQuIiIukbWY2QwB3r8zsQHL5CRDJ4nMiotO/N5gQwCLiBmDWY+ad5ByAJu7BUI7afp8HJ0n7P5K4I7nukvj6hQ2ARcEKV0nHr18oGPopeQBKBHgR4L5yxAAAAABJRU5ErkJggg==) no-repeat 2px;\npadding-left: 20px;\ncursor: hand;\npadding-right: 10px;");class Y{constructor(e,t,i){this.jelem=e,this.clicker=i,this.index,this.updateLayout(),this.originIndex=this.index,this.offsetY=this.layouts[this.index].y-t.pageY}updateLayout(){let e=[];for(let t of this.jelem.siblings())e.push(this.getLayoutOfElement(t));let t=this.getLayoutOfElement(this.jelem.get(0));e.push(t),e.sort(((e,t)=>e.y-t.y)),this.layouts=e,this.index=this.layouts.findIndex((e=>e.y==t.y))}getLayoutOfElement(e){let t=e.getBoundingClientRect();return{x:t.x,y:t.y,w:t.width,h:t.height}}handleEvent(e){let t,i=e.pageY+this.offsetY;for(t=0;t<this.layouts.length;t++){let e=this.layouts[t];if(i<e.y+e.h/2)break}if(t==this.index||t==this.index+1)return;let n=this.jelem.parent().get(0);t>=this.layouts.length?n.appendChild(this.jelem.get(0),this.jelem.siblings(this.layouts.length).get(0)):n.insertBefore(this.jelem.get(0),n.children[t]),this.updateLayout()}handleEnd(e){this.originIndex!=this.index&&getJelem(this.jelem,V).wrap().handleMEditChange()}}class z{create(){return $("<div/>").append($("<button/>",{style:""}).text("")).append($("<button/>").click((e=>{e.preventDefault(),e.stopPropagation(),getJelem(e.target,z).trigger("sideclick")})))}css(){return{"":"display:inline-block",button:"border: 1px solid gray; height: 25px; background-color: #EEEEEE; background-repeat: no-repeat; background-position: center;","button:hover":"background-color: #DDDDDD;",">:first-child":"width:100px;border-radius: 3px 0px 0px 3px;background-image: url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQAQMAAAAlPW0iAAAAAXNSR0IB2cksfwAAAAlwSFlzAAALEwAACxMBAJqcGAAAAAZQTFRFAAAAUVFRd9XwPwAAAAJ0Uk5TAP9bkSK1AAAAFklEQVR4nGNggAHGBgSS/wFCyCIwAACSawY3SvR/WAAAAABJRU5ErkJggg==);",">:last-child":"width: 16px; margin-left: -1px; border-radius: 0px 3px 3px 0px;background-image: url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAAXNSR0IArs4c6QAAAGRJREFUOE9jZKAQMFKon2HUAAbUMAgODlb99+/fVgYGBlYcgfubiYnJe+3atbdh8hiBiGSIKpoht9E1g+SxxgIWQ7BqxmkASALJEAZsNuP0ArKzQYaA+Mh+Rg+b0YSEIxpJyaEA8LwnEYBFeiAAAAAASUVORK5CYII=);"}}}class V{create(e,t,i){let n=i.write&&((e,t)=>{getJelem(t,V).wrap().handleMEditChange()});i=Object.assign({},i,{onchange:n});let s=$("<div />").prop("entity",e).prop("options",i).append($("<div/>").append((e||[]).map((t=>V.createEditableEntry(t,e.getEntityMeta(),i))))).append(i&&(i.write||i.writable&&e.getEntityMeta().fields)&&$("<div/>",{style:"padding: 5px"}).append(createJelem(z,{}).click((e=>getJelem(e.target,V).wrap().add())).on("sideclick",(e=>{getJelem(e.target,V).wrap().showPop()}))));return e instanceof L&&e.getListener().add("eList",(e=>s.wrap().handleEntityEvent(e))),s}static createEditableEntry(e,t,i){return t.fields&&t.fields.length?se(e,t,i):$("<div/>",{style:"display:flex; margin-bottom: 2px"}).append(se(e,t,i)).append($(i&&i.write&&$("<div/>",{style:"flex:0 0 16px;",class:H}).click((e=>{let t=e.target.getBoundingClientRect(),i=$(e.target).parent();ge($("<div/>").append(createJelem(ue,null,"Delete",(()=>{let e=getJelem(i,V);i.remove(),e.wrap().handleMEditChange()}))),100,null,t.x+t.width-100,t.y+t.height)})).on("pointerdown",(e=>{ye(e.pointerId)})).on("dragstart",(e=>{let t=$(e.target).parent();we(t,e,new Y(t,e,$(e.target)))}))))}wrap(){return class{add(){let e=this.children(":last-child").get(0),t=e.getBoundingClientRect().y,i=this.prop("entity");i?i.push():this.children(":first-child").append(V.createEditableEntry(void 0,this.prop("entity").getEntityMeta(),{write:!0}));let n=this.getScrollableElem(e);n&&n.scrollBy(0,e.getBoundingClientRect().y-t)}showPop(){let e=this.children(":last-child").children(":last-child").get(0).getBoundingClientRect(),t=this;ce($("<div/>").append(createJelem(ue,null,"Copy",(()=>t.wrap().copy()))).append(createJelem(ue,null,"Paste",(()=>t.wrap().paste()))),e.width,null,{x:e.x,y:e.y,w:e.width,h:e.height},this)}copy(){navigator.clipboard.writeText(JSON.stringify(this.prop("entity")))}async paste(){try{let e=JSON.parse(await navigator.clipboard.readText());e=e instanceof Array?e:[e];let t=[];for(let i of e)t.push(this.prop("entity").push(B(i)));t.length>0&&t[0].getListener().publish({type:"focus"})}catch(e){}}getScrollableElem(e){for(;e&&e!=document.body&&e.scrollHeight<=e.clientHeight;)e=e.parentNode;return e}remove(e){}handleEntityEvent(e){if("change"==e.type){let e=this.prop("entity"),t=e.getEntityMeta(),i=t.fields&&t.fields.length,n=this.prop("options");T(this.children(":first-child"),e,(e=>i?e.prop("entity"):le(t,e.children()[0])),(e=>V.createEditableEntry(e,t,n)))}else"focus"==e.type&&this.get(0).scrollIntoView(!1)}handleMEditChange(){let e=this.prop("entity");e&&e.update(this.parse())}parse(){let e=[],t=this.prop("entity").getEntityMeta(),i=this.children(":first-child").children(),n=t.fields&&t.fields.length;for(let s=0;s<i.length;s++){let r=re(n?$(i[s]).get(0):$(i[s]).children(":first-child").get(0),t);e.push(r)}return e}}}}function G(e){for(;e&&e!=document.body&&e.scrollHeight<=e.clientHeight;)e=e.parentNode;return e}function X(e,t){return J(t)||""===t?e.html("&nbsp;"):e.text(t)}class q{constructor(e,t){this.jelem=e,this.index,this.updateLayout(),this.originIndex=this.index,this.offsetY=this.layouts[this.index].y-t.pageY}updateLayout(){let e=[];for(let t of this.jelem.siblings())e.push(this.getLayoutOfElement(t));let t=this.getLayoutOfElement(this.jelem.get(0));e.push(t),e.sort(((e,t)=>e.y-t.y)),this.layouts=e,this.index=this.layouts.findIndex((e=>e.y==t.y))}getLayoutOfElement(e){let t=e.getBoundingClientRect();return{x:t.x,y:t.y,w:t.width,h:t.height}}handleEvent(e){let t,i=e.pageY+this.offsetY;for(t=0;t<this.layouts.length;t++){let e=this.layouts[t];if(i<e.y+e.h/2)break}if(t==this.index||t==this.index+1)return;let n=this.jelem.parent().get(0);t>=this.layouts.length?n.appendChild(this.jelem.get(0),this.jelem.siblings(this.layouts.length).get(0)):n.insertBefore(this.jelem.get(0),n.children[t]),this.updateLayout()}handleEnd(e){this.originIndex!=this.index&&this.jelem.wrap().handleEntityMove(this.originIndex,this.index)}}class Z{create(e,t,i){let n=i;i={...i},0!=e.getStorageStatus()&&(i.write=!0);let s=i.write||i.writable,r=$("<div/>").attr("id",e&&e._id).prop("entity",e instanceof R&&e).prop("options",n).append($("<div/>").append((s||i.code||navigator.clipboard)&&$("<div/>",{class:H,style:"float:right;"}).click((e=>getJelem(e.target,Z).wrap().showMenu()))).append(e.getEditable()&&s&&$("<button/>",{class:U}).text("Cancel").click((()=>getJelem(event.target,Z).wrap().cancel()))).append(e.getEditable()&&s&&$("<button/>",{class:W}).text("Save").click((()=>getJelem(event.target,Z).wrap().save()))).append(X($("<span/>",{class:K}),ne(e.getMeta(),e)).click((e=>getJelem(e.target,Z).wrap().switchCollapse(null,e.shiftKey)))).attr("draggable",s).on("pointerdown",s&&(e=>{ye(e.pointerId)})).on("dragstart",s&&(e=>{let t=getJelem(e.target,Z);we(t,e,new q(t,e))})).on("dblclick",s&&(e=>{"DIV"==e.target.tagName&&getJelem(e.target,Z).wrap().switchEdit()}))).append($("<div/>").append());return e instanceof R&&e.getListener().add("eControl",(e=>r.wrap().handleEntityEvent(e))),r.prop("edit",i.write),r.wrap(Z).render(),r}css(){return{"":"margin:5px; \n            padding:5px; \n            border-radius:5px; \n            font-size:14px; \n            word-break: break-all;\n            box-shadow: 0px 2px 5px 0px rgba(9,30,66,0.12)",">div:first-child":"background-color:#DDDDDD; height:25px; padding:2px; display:flex; align-items:center; flex-direction: row-reverse",".editable":"border: 1px solid gray; border-radius: 3px; padding: 3px"}}wrap(){return class{showMenu(){let e=this.children(":first-child").children(":first-child").get(0).getBoundingClientRect(),t=this,i=this.prop("options")||{},n=this.prop("entity"),s=i.write||i.writable,r=$("<div/>").append(s&&createJelem(ue,null,"Edit",(()=>t.wrap().edit()))).append(s&&n.getParent()instanceof L&&createJelem(ue,null,"Duplicate",(()=>t.wrap().duplicate()))).append(navigator.clipboard&&createJelem(ue,null,"Copy",(()=>t.wrap().copy()))).append(navigator.clipboard&&createJelem(ue,null,"Paste",(()=>t.wrap().paste()))).append(i.code&&createJelem(ue,null,(this.prop("code")?"Hide":"Show")+" Code",(()=>t.wrap().switchCode()))).append(s&&n.getParent()instanceof L&&createJelem(ue,null,"Delete",(()=>t.wrap().delete())));r.children().length>0&&ge(r,100,null,e.x+e.width-100,e.y+e.height,this)}async handleEntityMove(e,t){let i=this.prop("entity");i&&(parent=i.getParent(),parent&&parent instanceof L&&parent.move(e,t))}async edit(){this.prop("entity").setStorageStatus(1)}async save(){await this.prop("entity").save()}async switchEdit(){this.prop("edit")?await this.save():await this.edit()}async switchCode(){this.prop("code",!this.prop("code")),this.render()}async duplicate(){let e=this.get(0).getBoundingClientRect(),t=this.prop("entity");t.getParent().push(B(t));let i=this.parent().children(":last-child").get(0).getBoundingClientRect(),n=G(this.get(0));n&&n.scrollBy(0,i.y-e.y)}async copy(){navigator.clipboard.writeText(JSON.stringify(this.prop("entity")))}async paste(){try{let e=JSON.parse(await navigator.clipboard.readText());this.prop("entity").setStorageStatus(1).update(B(e))}catch(e){}}async delete(){await this.prop("entity").delete()}async cancel(){await this.prop("entity").cancel()}handleEntityEvent(e){if("storageChange"==e.type){let e=0!=this.prop("entity").getStorageStatus();e!=this.prop("edit")&&(this.prop("edit",e),this.render())}else"focus"==e.type&&this.get(0).scrollIntoView(!0)}needsHead(){let e=this.prop("options")||{},t=this.prop("entity"),i=e.write||e.writable;return t.getParent()instanceof L||t.getEditable()&&i||e.code}render(){let e=this.prop("entity"),t=e.getMeta(),i=this.prop("options")||{};this.children(":first-child").css("display",this.needsHead()?"":"none"),this.children(":first-child").find("button").css("display",this.prop("edit")&&e.getStorageStatus()?"inline-block":"none"),X(this.children(":first-child").children(":last-child"),ne(t,e)),this.prop("edit")&&this.switchCollapse(!1,!1),this.getEntityContainerJelem().html("").append(this.prop("code")?$("<div/>",{style:"white-space: pre-wrap"}).attr("contentEditable",!!this.prop("edit")&&"plaintext-only").attr("tabIndex",-1).attr("class",this.prop("edit")?"editable":null).append(JSON.stringify(e,null,"    ")):ae(t,e,{write:this.prop("edit"),writable:i.writable}))}getEntityContainerJelem(){return this.children(":first-child").next()}parse(){let e=this.prop("entity"),t=this.getEntityContainerJelem().children(":last-child");return this.prop("code")?JSON.parse(t.text()):le(e.getMeta(),t.get(0))}switchCollapse(e,t){let i=this.getEntityContainerJelem(),n="none"==i.css("display");if(n!=(e=J(e)?!n:e)&&(i.css("display",e?"none":""),this.children(":first-child").children("span").attr("class",e?Q:K)),t){let t=this.siblings();for(let i=0;i<t.length;i++)$(t[i]).wrap().switchCollapse(e,!1)}}}}}class ee{create(e,t,i){let n=document.createElement("table");n.style.width="100%",n.meta=e,ee.getDynamicTriggers(e);let s=i.write&&((e,t)=>getJelem(t,ee).wrap().onMeditChange(e,t));i=Object.assign({},i,{onchange:s}),n.options=i,t instanceof R&&(n.entity=t,t.getListener().add("oTable",(e=>$(n).wrap().onEntityChange(e))));let r=0;for(let t of e.fields){let e=(a=t.key,l="14px Arial",o=void 0,o=te.getContext("2d"),o.font=l,o.measureText(a)).width;r=Math.max(r,e)}var a,l,o;for(let s of e.fields){let e=s.key,a=t&&t[e],l=n.insertRow();$(l.insertCell()).text(e).css("vertical-align","top").css("width",r+2+"px").attr("title",s.description),$(l.insertCell()).append(se(a,s,i))}if(e.render?.compact&&i.write){let e=n.insertRow();$(e.insertCell()).attr("colspan",2).append($("<div/>",{style:"height: 12px; border-radius: 0px 0px 5px 5px; background: #DDDDDD url(../pics/arrow_white_down.png) no-repeat center; cursor:hand"}).click((e=>getJelem(e.target,ee).wrap().switchCompact())))}return ee.updateObjectDisplay(n,e,t,i),$(n)}static isFieldIgnorable(e,t){if(!1===e.render?.ignorable)return!1;if(e.array)return null==t||t.length<=0;if(t instanceof R){if(0!=t.getStorageStatus())return!1;for(let e of t.getMeta().fields)if(!ee.isFieldIgnorable(e,t[e.key]))return!1;return!0}return"enum"==e.type?null==t||""===t:null==t||!1===t||""===t}static updateObjectDisplay(e,t,i,n){let s=e.rows;if(s.length<=0)return;let r=s[s.length-1].cells,a=1==r.length?r[0].childNodes[0]:null,l=a&&$(a).css("background-image").indexOf("up")<0;for(let e of s)if(2==e.cells.length){let s=e.cells[0].innerText,r=t.fields.find((e=>e.key==s)),a=!ee.validateFieldCond(r,i)||(!n?.write||t.render?.compact&&l)&&t.render?.ignorable&&ee.isFieldIgnorable(r,i[s])?"none":"";e.style.display!=a&&(e.style.display=a)}}static validateFieldCond(e,t){if(e&&e.cond)for(let i in e.cond)if(!t||t[i]!==e.cond[i])return!1;return!0}static getDynamicTriggers(e){let t={};for(let i in e.fields)if(e.fields[i].cond)for(let n in e.fields[i].cond)t[n]=1;return t}wrap(){return class{onMeditChange(e,t){let i=this.get(0),n=this.prop("meta"),s=this.prop("entity");ee.updateObjectDisplay(i,n,this.parse(),this.prop("options")),s&&(s[e]=re(t,n.fields.find((t=>t.key==e))))}findFieldRow(e){for(let t of this.get(0).rows)if(2==t.cells.length&&t.cells[0].innerText==e)return t}onEntityChange(e){if("fieldChange"==e.type){let t=this.findFieldRow(e.key);if(t){let i=this.prop("meta").fields.find((t=>t.key==e.key));re(t.cells[1].children[0],i)!==e.value&&($(t.cells[1]).html("").append(se(e.value,i,this.prop("options"))),ee.updateObjectDisplay(this.get(0),this.prop("meta"),this.prop("entity"),this.prop("options")))}}else if("childEvent"==e.type){let t=e.jpath.indexOf(".");t>0?e.jpath.substring(0,t):e.jpath,ee.updateObjectDisplay(this.get(0),this.prop("meta"),this.prop("entity"),this.prop("options"))}}parse(){let e=this.prop("meta"),t=this.get(0),i={};for(let n of t.rows)if(2==n.cells.length){let t=n.cells[0].innerText,s=e.fields.find((e=>e.key==t));i[t]=re(n.cells[1].children[0],s)}return i}switchCompact(){let e=this.get(0),t=this.get(0).rows,i=t[t.length-1].cells,n=1==i.length?i[0].childNodes[0]:null;if(n){n=$(n);let t=n.css("background-image").indexOf("up")<0;n.css("background-image",`url(../pics/arrow_white_${t?"up":"down"}.png)`),ee.updateObjectDisplay(e,this.prop("meta"),this.prop("entity"),this.prop("options"))}}}}}let te=document.createElement("canvas");function ie(e,t,i){return createJelem(ee,e,t,i)}function ne(e,t){if(!t)return"";let i=e.fields.find((e=>e.asLabel)),n=t[i?i.key:e.fields[0].key];return J(n)?"":n.toString().trim()}function se(e,t,i){return!t&&(e instanceof R||e instanceof L)&&(t=e.getMeta()),t.array?createJelem(V,e,t,i):D(t.type)?createJelem(Z,e,t,i):ae(t,e,i)}function re(e,t){return t.array?getJelem(e,V).wrap().parse():D(t.type)?getJelem(e,Z).wrap().parse():le(t,e)}function ae(e,t,i){let n=me(e);return i&&i.write?n.render(e,t,i):n.present(e,t,i)}function le(e,t){return me(e).parse(t,e)}function oe(e,t){return getJelem(e,ee).wrap().parse()}function de(e){if(_.isArray(e))return{...de(e[0]),array:!0};if(_.isObject(e))return{type:"object",fields:_.map(e,((e,t)=>({...de(e),key:t})))};if(_.isBoolean(e))return{type:"boolean"};if(_.isString(e))return{type:"string"};if(_.isNumber(e))return{type:"number"};throw new Error("Invalid Type")}const pe=createClass({":focus":"outline:none"," .popupmenu":"padding:4px 6px 4px 6px; cursor:hand"});let he;function ce(e,t,i,n,s){he&&(he.remove(),he=null);let r=0,a=0;if(s)for(let e=s.get(0);null!=e&&e!=document.body;e=e.parentNode)if("DIALOG"==e.tagName){let t=e.getBoundingClientRect();r-=t.x,a-=t.y;break}he=$("<div/>",{class:pe}).append(e).attr("tabindex",-1).attr("outline",0).attr("hidefocus",!0),he.css("position","absolute").css("width",t).css("height",i).css("background-color","white").css("border","1px solid #aaaaaa").css("box-shadow","2px 2px 5px 2px rgba(9,30,66,0.12)").on("blur",(e=>{he.remove()})).on("mousedown",(e=>{he.remove()})).appendTo($(s||document.body));let l=n.x+n.w-t,o=n.y+n.h;if(n.h){let e=document.body.clientHeight;i||(i=he.get(0).getBoundingClientRect().height),o+i>e&&(o=n.y-i)}he.css("left",l+document.body.scrollLeft+r),he.css("top",o+document.body.scrollTop+a),he.focus()}function ge(e,t,i,n,s,r){ce(e,t,i,{x:n+t,y:s,w:0,h:0},r)}class ue{create(e,t,i){return $("<div/>").text(t).attr("class","popupmenu").mousedown(i)}css(){return{":hover":"background-color:#4288FF; color:white"}}}var fe;function ye(e){fe=e}function we(e,t,i){let n=e.parent().get(0);t.preventDefault();let s=e=>{i.handleEvent(e)},r=e=>{n.removeEventListener("pointermove",s),n.removeEventListener("pointerup",r),n.releasePointerCapture(fe),i.handleEnd&&i.handleEnd(e)};n.addEventListener("pointermove",s),n.addEventListener("pointerup",r),n.setPointerCapture(fe)}function me(e){return e.typeId&&p(e.typeId)||p(e.type)}d("object",new class{render(e,t,i){return ie(e,t,i)}parse(e,t){return oe(e)}present(e,t,i){return ie(e,t,i)}getLabel(e,t){return ne(e,t)}});class be{create(e,t){return $("<div/>").attr("tabindex",-1).css("width","300px").css("height","300px").css("background-image",e&&`url("${e}")`)}css(){return{"":"background-size: contain; background-repeat: no-repeat; background-position: center;border: 1px solid gray; border-radius: 3px"}}wrap(){return class{parse(){let e=this.css("background-image").match(/url\((.*?)\)/);return e?e[1].replace(/(?:^"|"$)/g,""):""}}}}async function Ae(e,t){var i=new FormData;i.append("file",function(e){for(var t=atob(e.split(",")[1]),i=e.split(",")[0].split(":")[1].split(";")[0],n=new ArrayBuffer(t.length),s=new Uint8Array(n),r=0;r<t.length;r++)s[r]=t.charCodeAt(r);return new Blob([n],{type:i})}(event.target.result),"a.png"),i.append("seq",123);let n=await fetch("/api/projects/64256f7ce039047b1e7ce4c0/images",{method:"POST",body:i});return await n.json()}bindClassHandler(be,"drop",(async(e,t,i)=>{i.preventDefault();let n=i.dataTransfer.files;if(1==n.length&&n[0].type.match(/^image\//)){let e=await(s=n[0],new Promise(((e,t)=>{let i=new FileReader;i.onload=async function(t){e(t.target.result)},i.readAsDataURL(s)})));i.target.style.backgroundImage="url("+e+")";let t=await Ae(n[0].name);i.target.style.backgroundImage="url("+t.path+")"}var s})),d("image",new class{render(e,t){return createJelem(be,t,e)}parse(e){return"IMG"==e.tagName?e.src:getJelem(e,be).wrap().parse()}present(e,t){return $("<img/>",{src:t,style:'width:300px; background-repeat: no-repeat; background-position: center; background-image: url("../pics/loading-gif.gif")'})}});class xe{async patchAllEntities(e,t){let i=[];for(let n of t){let t={...n};i.push(t);let s=n.jpath;if(s.startsWith("#")){let i=s.indexOf(".");if(i<0){let i=s.substring(1);if(n.new)if(n.old){if(!await this.getEntity(e,i))continue;t.new=await this.updateEntity(e,i,n.new)}else t.new=await this.addEntity(e,n.new);else n.old&&await this.deleteEntity(e,i)}else{if(J(n.old)&&J(n.new))continue;let t=s.substring(1,i),r=await this.getEntity(e,t);if(!r)continue;N(r,s.substring(i+1),n.old,n.new),await this.updateEntity(e,t,r)}}else if(s){if(J(n.old)&&J(n.new))continue;let t=await this.getAllEntities(e);N(t,s,n.old,n.new),await this.setAllEntities(e,t)}else await this.setAllEntities(e,n.new)}return JSON.parse(JSON.stringify(i))}}function _e(e,t){let i=$("<div/>").click(ve);return e instanceof L&&(i.append(e.map(Ee)),e.getListener().add("contents",(t=>function(e,t,i){if("change"==i.type)T(t,[...e,e],(e=>e.prop("entity")),Ee);else if("childEvent"==i.type&&"fieldChange"==i.event.type&&i.jpath.indexOf(".")<0){let e=t.children().toArray(),n=i.jpath.substring(1),s=e.find((e=>e.entity.getId()==n));if(s){let e=$(s),t=ne(s.entity.getMeta(),s.entity);t!=e.text()&&X(e,t)}}}(e,i,t))),i.append(ke(e,"(End)").css("font-style","italic"))),i}function ve(){try{event.target.entity.getListener().publish({type:"focus"})}catch(e){}}function Ee(e){return ke(e,ne(e.getMeta(),e))}function ke(e,t){return X($("<div/>",{style:"padding: 2px 2px 2px 18px; cursor: hand; white-space: nowrap"}),t).prop("entity",e)}b("localstorage://entities/:model",new class extends xe{async getAllEntities(e){let t=window.localStorage.getItem(e.model)||"",i=[];if(t){let n=t.split(",");for(let t of n)i.push(await this.getEntity(e,t))}return i}async addEntity(e,t){let i=window.localStorage.getItem(e.model)||"",n=t._id||crypto.randomUUID();i+=(i?",":"")+n.toString();let s=JSON.stringify({_id:n,...t});return window.localStorage.setItem(`${e.model}.${n}`,s),window.localStorage.setItem(e.model,i),JSON.parse(s)}async getEntity(e,t){let i=window.localStorage.getItem(`${e.model}.${t}`);return i?JSON.parse(i):void 0}async updateEntity(e,t,i){let n=window.localStorage.getItem(e.model)||"";if(n&&n.split(",").find((e=>e==t))){let n=JSON.stringify({_id:t,...i});return window.localStorage.setItem(`${e.model}.${t}`,n),JSON.parse(n)}}async deleteEntity(e,t){let i=window.localStorage.getItem(e.model)||"";if(i){let n=i.split(",");n.find((e=>e==t))&&(window.localStorage.removeItem(`${e.model}.${t}`),window.localStorage.setItem(e.model,n.filter((e=>e!=t)).join(",")))}}});class De{constructor(e,t,i){this.sliderbar=e,this.startWidth=e.getWidth(),this.adjust=-t.pageX,this.reverse=i}handleEvent(e){this.sliderbar.setWidth(this.startWidth+(this.reverse?-e.pageX-this.adjust:e.pageX+this.adjust))}handleEnd(e){this.sliderbar.save()}}class Me{create(e){return $("<div/>").prop("options",e).append($("<div/>",{style:"flex: 0 0 48px; background-color:#999999; display: flex; align-items: center; flex-direction: column;"})).append($("<div/>",{style:"flex: 1 1; overflow: auto"})).append($("<div/>",{style:"flex: 0 0 12px; height: 100%; cursor: ew-resize; width:12px;"}).attr("draggable",!0).append($("<div/>",{class:"slide"}).css("left","right"==e?.float?"10px":"-3px")).on("pointerdown",(e=>ye(e.pointerId))).on("dragstart",(t=>{let i=getJelem(t.target,Me).wrap();we(i,t,new De(i,t,"right"==e?.float))})))}css(){return{"":"display: flex",".icon":"padding:3px; margin-top:10px; border-radius: 5px; cursor:hand",".slide":"width:3px; height: 100%; position: relative; background: linear-gradient(to left, rgba(0, 0, 0, 0.2) 0px, rgba(0, 0, 0, 0.2) 1px, rgba(0, 0, 0, 0.1) 1px, rgba(0, 0, 0, 0) 100%)"}}wrap(){return class{setWidth(e){this.isHidden(e)?this.hide():(this.restore(),this.css("flex",`0 0 ${e}px`))}hide(){let e=this.children(":first-child"),t=e.next();"none"!=t.css("display")&&(this.prop("oldSelected",this.getSelectedIndex()),this.css("flex","0 0 60px"),t.css("display","none"),e.children().css("background-color",""),t.children().css("display","none"))}restore(){let e=this.children(":first-child"),t=e.next();"none"==t.css("display")&&(t.css("display","block"),$(e.children[this.prop("oldSelected")]).css("background-color","white"),this.css("flex",`0 0 ${Math.abs(this.loadWidth(this.prop("options")?.key))}px`),this.save(),this.select(this.prop("oldSelected")))}getSelectedIndex(){let e=this.children(":first-child").next().children();for(let t=0;t<e.length;t++)if("none"!=$(e[t]).css("display"))return t;return-1}getWidth(){let e=(this.css("flex")||"").match(/([\d\.]+)px$/);return e?parseFloat(e[1]):200}save(){let e=this.prop("options")?.key;if(e){let t=this.getWidth();window.localStorage.setItem(e,this.isHidden(t)?-Math.abs(this.loadWidth(e)):t)}}isHidden(e){return e<80}loadWidth(e){let t=parseFloat(window.localStorage.getItem(e));return isNaN(t)?260:t}load(){let e=this.loadWidth(this.prop("options")?.key);return e<0?this.hide():this.setWidth(e),this}select(e){let t=this.children(":first-child"),i=t.children(),n=t.next().children(),s=$(i[e]),r=$(n[e]);this.getSelectedIndex()==e?(this.hide(),this.save()):(this.restore(),i.css("background-color",""),s.css("background-color","white"),n.css("display","none"),r.css("display","block"))}add(e,t,i){let n=this.children(":first-child");return n.append($("<img/>",{src:t,title:e,class:"icon"}).click((e=>{let t=0;for(let i=e.target;null!=i;i=i.previousSibling)console.log(i.tagName),t++;getJelem(e.target,Me).wrap().select(t-1)}))),n.next().append($("<div/>").append(i()).css("display","none")),1==n.children().length&&this.select(0),this}}}}function Se(e,t){let i={};for(let n=getJelem(e,Z);n;n=getJelem(n.parent(),Z)){let e=n.prop("entity");for(let n in t)if(!i.hasOwnProperty(n)){let t=e[n];J(t)||(i[n]=t)}}return i}class Ce{constructor(e,t,i){this.sliderbar=e,this.startWidth=e.getWidth(),this.adjust=-t.pageX,this.reverse=i}handleEvent(e){this.sliderbar.setWidth(this.startWidth+(this.reverse?-e.pageX-this.adjust:e.pageX+this.adjust))}handleEnd(e){this.sliderbar.save()}}class Oe{create(e){return $("<div/>").attr("draggable",!0).prop("options",e).css("margin-left","right"==e?.float?"":"auto").append($("<div/>").css("left","right"==e?.float?"10px":"-3px").append($("<div/>",{class:"switch"}).css("transform","right"==e?.float?"rotate(180deg)":"none").click((e=>getJelem(e.target,Oe).wrap().switch())))).on("pointerdown",(e=>ye(e.pointerId))).on("dragstart",(t=>{let i=getJelem(t.target,Oe).wrap();we(i,t,new Ce(i,t,"right"==e?.float))}))}css(){return{"":"flex: 0 0 12px; height: 100%; cursor: ew-resize; width:12px",">div":"width:3px; height: 100%; position: relative; background: linear-gradient(to left, rgba(0, 0, 0, 0.2) 0px, rgba(0, 0, 0, 0.2) 1px, rgba(0, 0, 0, 0.1) 1px, rgba(0, 0, 0, 0) 100%)",".switch":"cursor:hand; box-shadow: 0px 2px 5px 0px rgba(9,30,66,0.12); position:relative; left: -10px; top: 30px; background: white url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAAXNSR0IArs4c6QAAAOhJREFUOE+9kzFqAkEUhudftvMwFskBUovFm0fwBDF26VIK4imMFh5g2XmzhYRAIBcwjcFOvIPa7wsLI4iIOyI63cD/ffyPNwNz5cGVvLmPgIgGABoi8n7cuLYBM3+o6msFJknSzPN8cSg5K2DmvqoOAzATkXZ0A2tt1xgzDsAfAHLOraMERPQE4CeENwCenXPfpzZ2cgQiegAwrwBV3apqpyiKr2hBFWTmnqqOArRM05SyLFtFjbAPEdEQQD/cP0WkdZGgCltrJ8aYlzDOo/f+N3qN+yAzT8uy3Hnv3y5uUPdXal/izQX/3wFKEahfekEAAAAASUVORK5CYII=) repeat center; width: 22px; height:22px; border-radius: 50%; border: 1px solid #CCCCCC;"}}wrap(){return class{switch(){this.isHidden(this.getWidth())?this.restore():this.hide(),this.save()}setWidth(e){this.isHidden(e)?this.hide():(this.restore(),this.parent().css("flex",`0 0 ${e}px`))}restore(){this.isHidden(this.getWidth())&&(this.siblings().css("display",""),this.getChild().css("transform","right"==this.prop("options")?.float?"rotate(180deg)":"none"),this.parent().css("flex",`0 0 ${Math.abs(this.loadWidth(this.prop("options")?.key))}px`),this.save())}isHidden(e){return e<40}getChild(){return this.children(":first-child").children(":first-child")}hide(){this.isHidden(this.getWidth())||(this.parent().css("flex","0 0 26px"),this.siblings().css("display","none"),this.getChild().css("transform","right"==this.prop("options")?.float?"none":"rotate(180deg)"))}getWidth(){return parseFloat(this.parent().css("flex").match(/([\d\.]+)px$/)[1])}save(){let e=this.prop("options")?.key;if(e){let t=this.getWidth();window.localStorage.setItem(e,t<40?-Math.abs(this.loadWidth(e)):t)}}loadWidth(e){let t=parseFloat(window.localStorage.getItem(e));return isNaN(t)?200:t}load(){let e=this.loadWidth(this.prop("options")?.key);e<0?this.hide():this.setWidth(e)}}}}var je=t.TK,Ie=t.ux,Je=t.sP,Pe=t.cU,$e=t.Ce,Ne=t.iK,Be=t.Ks,Re=t.VN,Le=t.fw,Fe=t.Hv,Te=t.vD,Ue=t.Gh,We=t.kK,He=t.u7,Qe=t.tP,Ke=t.Fi,Ye=t.wn,ze=t.$W,Ve=t.eJ,Ge=t.H6,Xe=t.Fn,qe=t.L4,Ze=t.fM,et=t.Lg,tt=t.v5,it=t.U,nt=t.CA,st=t.jl;export{je as BasicStorage,Ie as CSS,Je as ContentsPanel,Pe as SlideBar,$e as addEntity,Ne as deduceMeta,Be as deleteEntity,Re as getAllEntities,Le as getContext,Fe as getEntity,Te as getObjectLabel,Ue as getScrollableElem,We as isNil,He as loadModel,Qe as makeModel,Ke as normalizeData,Ye as parseField,ze as parseObject,Ve as registerEntityStorage,Ge as registerFieldHandler,Xe as registerType,qe as renderContents,Ze as renderField,et as renderObject,tt as setDragPointer,it as showPopup,nt as startDragging,st as traverseModel};